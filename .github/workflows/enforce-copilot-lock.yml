name: Enforce CoPilot Lock

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  validate-copilot-lock:
    name: Validate CoPilot Lock reference
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate PR references primary roadmap files
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = '.github/copilot-lock.json';
            if (!fs.existsSync(path)) {
              throw new Error(`${path} not found in repository`);
            }
            const lock = JSON.parse(fs.readFileSync(path, 'utf8'));
            const files = lock.primary_roadmap_files || [];
            const pr = context.payload.pull_request;
            if (!pr) {
              throw new Error('This workflow must run on pull_request events with PR context.');
            }
            const text = `${pr.title || ''}\n\n${pr.body || ''}`;
            const matched = files.some(f => {
              if (!f) return false;
              // match by substring, filename, or path fragment
              try {
                const fileName = f.split('/').filter(Boolean).pop();
                return text.includes(f) || text.includes(fileName) || text.includes(f.replace(/^\/+/, ''));
              } catch (e) {
                return false;
              }
            });
            if (!matched) {
              throw new Error('PR must reference one of the primary roadmap files listed in .github/copilot-lock.json: ' + files.join(', '));
            }
